 
 
### 说明

本工程是多数据源配置分包模式的DEMO


**版本**


- springboot 2.2.2.RELEASE
- my

 
 
 
#### 相关工程


多数据动态切换注解+AOP： spring-boot-mutil-dynamic-datasource

多数据源配置分包方式：spring-boot-mybatis-mutil-datasource


#### 相关实现方式

https://blog.csdn.net/Java6888/article/details/108730853

- 分包方式。分包的前提是在编写代码的时候，就已经知道当前业务模型需要用哪个数据源
- 参数化切换。  参数化切换数据源，意思是，业务侧需要根据当前业务参数，动态的切换到不同的数据源。
- 注解+AOP
- 动态添加


 ##### 分包方式

 mapper接口、xml文件，需要按照不同的数据源分包。在操作数据库时，根据需要在service类中注入dao层。

 优点

 实现起来简单，只需要编写数据源配置文件和配置类，mapper接口和xml文件注意分包即可。

 缺点

 很明显，如果后面要增加或删除数据源，不仅要修改数据源配置文件，还需要修改配置类。
 例如增加一个数据源，同时还需要新写一个该数据源的配置类，同时还要考虑新建mapper接口包、xml包等，没有实现 “热插拔” 效果。

 ##### 参数化切换

 参数化切换数据源，意思是，业务侧需要根据当前业务参数，动态的切换到不同的数据源。

 适合于在运行时才能确定用哪个数据源。需要手动执行切换数据源操作；

 无需分包，mapper和xml路径自由定义；

 增加数据源，无需修改java配置类，只需修改数据源配置文件即可。

 ##### 注解方式

  该方式利用注解+AOP思想，为需要切换数据源的方法标记自定义注解，注解属性指定数据源ID，然后利用AOP切面拦截注解标记的方法，在方法执行前，切换至相应数据源；在方法执行结束后，切换至默认数据源。

  需要注意的是，自定义切面的优先级需要高于@Transactional注解对应切面的优先级。

  否则，在自定义注解和@Transactional同时使用时，@Transactional切面会优先执行，切面在调用getConnection方法时，会去调用AbstractRoutingDataSource.determineCurrentLookupKey方法，此时获取到的是默认数据源master。这时@DataSource对应的切面即使再设置当前线程的数据源key，后面也不会再去调用determineCurrentLookupKey方法来切换数据源了。

 本质与参数化的方式相类似，区别是判断依据发生变化


 （1）生成当前线程数据源key

 （3）根据ID从数据源缓存池中获取数据源对象，并再次添加到backupTargetDataSources缓存池中；

 （4）threadLocal设置当前线程对应的数据源key；

 （5）在执行数据库操作前，spring会调用determineCurrentLookupKey方法获取key，然后根据key去数据源缓存池取出数据源，然后getConnection获取该数据源连接；

 （6）使用该数据源执行数据库操作；

 （7）释放缓存：threadLocal清理当前线程数据源信息、数据源缓存池清理当前线程数据源key和数据源对象。


  #####  动态添加方式


  项目里面只配置了1个默认的数据源，而具体运行时需要动态的添加新的数据源，非已配置好的静态的多数据源。

  例如需要去服务器实时读取数据源配置信息（非配置在本地），然后再执行数据库操作。

  除了第6步外，利用之前写好的代码就可以实现。

  思路是：

  （1）创建新数据源；

  （2）DynamicDataSource注册新数据源；

  （3）切换：设置当前线程数据源key；添加临时数据源；

  （4）数据库操作（必须在另一个service实现，否则无法控制事务）；

  （5）清理当前线程数据源key、清理临时数据源；

  （6）清理刚刚注册的数据源；

  （7）此时已返回至默认数据源。



  四种方式对比

| 分包方式 | 参数化切换 | 注解方式 | 动态添加方式 |
| -------- | ---------- | -------- | ------------ |
| 适用场景  | 编码时便知道用哪个数据源	运行时才能确定用哪个数据源  | 编码时便知道用哪个数据源  |  运行时动态添加新数据源  |
| 切换模式  | 自动  | 手动  | 自动  | 手动  |
| mapper路径  | 需要分包  | 无要求  | 无要求  | 无要求  |
| 增加数据源是否需要修改配置类  | 需要  | 不需要  | 不需要	  |  \    |
| 实现复杂度  | 简单  | 复杂  | 复杂  | 复杂  |